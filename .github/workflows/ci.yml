name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Quick checks that run fast for immediate feedback
  quick-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          pip install flake8 black isort mypy

      - name: Check code formatting with Black
        run: black --check --diff .

      - name: Check import sorting with isort
        run: isort --check-only --diff .

      - name: Run flake8 linting (relaxed rules)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source \
          --statistics --max-line-length=88

      - name: Type checking with mypy (non-blocking)
        run: mypy . || echo "Type checking failed but continuing..."
        continue-on-error: true

  # Full test suite - only runs if quick checks pass
  full-tests:
    runs-on: ubuntu-latest
    needs: quick-checks
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Make scripts executable
        run: chmod +x start-dockers.sh stop-dockers.sh

      - name: Start Docker containers
        run: ./start-dockers.sh

      - name: Wait for services to be ready
        run: |
          timeout=60
          while [ $timeout -gt 0 ]; do
            if docker ps --format "table {{.Names}}\t{{.Status}}" | \
               grep pop-api | grep -q "Up"; then
              echo "FastAPI container is ready"
              break
            fi
            echo "Waiting for FastAPI container... ($timeout seconds left)"
            sleep 5
            timeout=$((timeout-5))
          done
          
          if [ $timeout -eq 0 ]; then
            echo "Timeout waiting for containers"
            docker ps
            docker logs pop-api
            exit 1
          fi

      - name: Install test dependencies
        run: |
          docker exec pop-api pip install --no-cache-dir \
            pytest pytest-cov pytest-asyncio

      - name: Run tests with coverage
        run: |
          docker exec pop-api pytest --cov=. --cov-report=xml \
            --cov-report=term --verbose

      - name: Upload coverage to Codecov (optional)
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

      - name: Cleanup containers
        if: always()
        run: ./stop-dockers.sh

  # Notification job for failures
  notify-failure:
    runs-on: ubuntu-latest
    needs: [quick-checks, full-tests]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Notify team of main branch failure
        run: |
          echo "::warning::Tests failed on main branch - immediate attention needed"
          # You can add Slack/Discord/Email notifications here